name: Java CI with Maven

permissions:
  contents: write

on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - f/*

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 17
        cache: 'maven'

    - name: Badge, valori di default
      run: |
        sed -i '/Build-Succes-green/c\"Build Status: ![Build Status](https://img.shields.io/badge/Build-Succes-green)"' README.md

    - name: Build with Maven
      id: maven_build
      run: mvn clean install --file roman-number/pom.xml

    - name: Build Badge
      if: always() && steps.maven_build.outcome == 'success'
      run: |
        sed -i '/Build-Failed-red/c\"Build Status: ![Build Status](https://img.shields.io/badge/Build-Succes-green)"' README.md
    
    - name: Spostare il report di copertura
      run: mv roman-number/target/site/jacoco/jacoco.xml .github/badge/

    - name: Committa e pusha il badge aggiornato
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .github/badge/jacoco.xml
        git add README.md
        git commit -m "Aggiornamento badge di copertura JaCoCo" || echo "Nessuna modifica da commettere"
        git push